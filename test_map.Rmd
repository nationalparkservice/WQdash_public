---
title: "Flexdashboard Leaflet Popup Test"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
library(sf)
library(htmlwidgets)
library(shinyjs)
library(purrr)      
library(htmltools)  
library(dplyr) 

debug_recent_data <- function(df) {
  cat("\n=== DEBUGGING RECENT DATA ===\n")
  for (i in 1:min(3, nrow(df))) {
    row <- df[i, ]
    cat("Row", i, "- Param:", row$CharacteristicName, "\n")
    cat("  Recent_Values:", row$Recent_Values, "\n")
    cat("  Recent_Dates:", row$Recent_Dates, "\n")
    
    # Test parsing
    vals <- suppressWarnings(as.numeric(unlist(strsplit(as.character(row$Recent_Values), ","))))
    dates <- as.character(unlist(strsplit(as.character(row$Recent_Dates), ",")))
    cat("  Parsed values:", paste(vals, collapse = ", "), "\n")
    cat("  Parsed dates:", paste(dates, collapse = ", "), "\n")
    cat("  Valid pairs:", sum(!is.na(vals) & dates != ""), "\n\n")
  }
}

# Dummy site coordinates
set.seed(1)
sites <- data.frame(
  MonitoringLocationIdentifier = paste0("Site_", 1:5),
  lon = runif(5, -90, -89),
  lat = runif(5, 29, 30)
)
sites_sf <- st_as_sf(sites, coords = c("lon", "lat"), crs = 4326)

# Dummy CharacteristicName tables for each site
make_params <- function(n) {
  # Realistic water quality parameters with appropriate units and ranges
  param_types <- data.frame(
    name = c("Dissolved Oxygen", "pH", "Temperature", "Turbidity", "Nitrate", "Phosphorus", "Conductivity", "Total Suspended Solids"),
    unit = c("mg/L", "pH units", "°C", "NTU", "mg/L", "mg/L", "μS/cm", "mg/L"),
    typical_low = c(4, 6.5, 10, 1, 0.1, 0.01, 50, 5),
    typical_high = c(12, 8.5, 25, 10, 5, 0.5, 500, 50),
    stringsAsFactors = FALSE
  )
  
  # Generate parameters for this site
  selected_params <- sample(1:nrow(param_types), min(n, nrow(param_types)))
  
  params_list <- lapply(selected_params, function(i) {
    param_info <- param_types[i, ]
    
    # Generate realistic ranges based on parameter type
    base_low <- param_info$typical_low
    base_high <- param_info$typical_high
    
    # Generate recent values WITHIN a reasonable range
    num_samples <- sample(3:8, 1)
    recent_values <- round(runif(num_samples, base_low * 0.8, base_high * 1.2), 2)
    recent_dates <- sort(sample(seq(as.Date('2022-01-01'), as.Date('2024-07-01'), by = "week"), num_samples), decreasing = TRUE)
    
    # Calculate actual min/max from simulated full historical dataset
    all_historical <- runif(100, base_low * 0.5, base_high * 1.5)
    actual_min <- round(min(all_historical), 2)
    actual_max <- round(max(all_historical), 2)
    
    data.frame(
      CharacteristicName = param_info$name,
      Sample_Size = sample(50:200, 1),
      Year_Range = paste0(sample(2000:2010, 1), "–", sample(2020:2024, 1)),
      Lowest_Value = actual_min,
      Highest_Value = actual_max,
      Most_Recent_Value = recent_values[1],
      Most_Recent_Sample_Date = recent_dates[1],
      Recent_Values = paste(head(recent_values, 5), collapse = ","),
      Recent_Dates = paste(head(recent_dates, 5), collapse = ","),
      Unit = param_info$unit
    )
  })
  
  do.call(rbind, params_list)
}

site_param_data <- setNames(
  lapply(sample(2:5, 5, TRUE), make_params),
  sites$MonitoringLocationIdentifier
)

full_data <- purrr::map_df(site_param_data, ~as.data.frame(.x), .id="MonitoringLocationIdentifier")

# Dummy threshold data
threshold_df <- data.frame(
  MonitoringLocationIdentifier = c(
    "Site_1", "Site_1", "Site_1",  # Dissolved Oxygen with 3 categories
    "Site_1", "Site_1",            # pH with 2 categories  
    "Site_2", "Site_2", "Site_2",  # Dissolved Oxygen with 3 categories
    "Site_2",                      # Temperature with 1 category
    "Site_3", "Site_3", "Site_3",  # pH with 3 categories
    "Site_3", "Site_3",            # Nitrate with 2 categories
    "Site_4", "Site_4", "Site_4",  # Nitrate with 3 categories
    "Site_5", "Site_5"             # Turbidity with 2 categories
  ),
  CharacteristicName = c(
    "Dissolved Oxygen", "Dissolved Oxygen", "Dissolved Oxygen",
    "pH", "pH",
    "Dissolved Oxygen", "Dissolved Oxygen", "Dissolved Oxygen", 
    "Temperature",
    "pH", "pH", "pH",
    "Nitrate", "Nitrate",
    "Nitrate", "Nitrate", "Nitrate",
    "Turbidity", "Turbidity"
  ),
  ThreshCateg = c(
    "good", "caution", "poor",     # Dissolved Oxygen at Site_1
    "good", "caution",             # pH at Site_1
    "good", "caution", "poor",     # Dissolved Oxygen at Site_2
    "good",                        # Temperature at Site_2
    "good", "caution", "poor",     # pH at Site_3
    "good", "caution",             # Nitrate at Site_3
    "good", "caution", "poor",     # Nitrate at Site_4
    "good", "caution"              # Turbidity at Site_5
  ),
  n = c(
    45, 8, 2,      # Dissolved Oxygen at Site_1: mostly good
    30, 5,         # pH at Site_1: mostly good
    38, 12, 5,     # Dissolved Oxygen at Site_2: mixed
    25,            # Temperature at Site_2: all good
    20, 15, 8,     # pH at Site_3: varied distribution
    22, 6,         # Nitrate at Site_3: mostly good
    18, 10, 4,     # Nitrate at Site_4: mixed
    35, 12         # Turbidity at Site_5: mostly good
  )
)

observeEvent(input$map_right_click, {
  site <- input$map_right_click$MonitoringLocationIdentifier
  df <- full_data %>% dplyr::filter(MonitoringLocationIdentifier == site)
  
  # TEMPORARY debug line
  debug_recent_data(df)
  
  shiny::showModal(
    shiny::modalDialog(
      title = paste("Summary for", site),
      generate_param_table(
        df = df,
        threshold_df = threshold_df,
        MonitoringLocationIdentifier = site
      ),
      easyClose = TRUE,
      size = "l"
    )
  )
})

# Function to generate table with horizontal bar
generate_param_table <- function(df, threshold_df, MonitoringLocationIdentifier) {
  
  # Pre-filter threshold data once
  filtered_thresholds <- threshold_df %>%
    dplyr::filter(tolower(as.character(MonitoringLocationIdentifier)) == tolower(as.character(!!MonitoringLocationIdentifier))) %>%
    dplyr::mutate(CharacteristicName_lower = tolower(as.character(CharacteristicName)))
  
  # CSS donut
  build_css_donut <- function(parts, colors, categories) {
    total <- sum(parts, na.rm = TRUE)
    if (total == 0) return('<div style="width: 80px; height: 80px; border-radius: 50%; background: #cccccc; display: flex; align-items: center; justify-content: center;"><span style="font-size: 12px;">0</span></div>')
    
    if (length(parts) <= 3) {
      percentages <- cumsum(parts) / total * 100
      stops <- paste0(colors, " ", c(0, head(percentages, -1)), "% ", percentages, "%")
      
      return(sprintf(
        '<div style="width: 80px; height: 80px; border-radius: 50%%; background: conic-gradient(%s); position: relative; display: flex; align-items: center; justify-content: center;"><div style="width: 35px; height: 35px; background: white; border-radius: 50%%; display: flex; align-items: center; justify-content: center;"><span style="font-size: 12px; font-weight: 600;">%d</span></div></div>',
        paste(stops, collapse = ", "), total
      ))
    }
    
    # SVG fallback 
    circumference <- 157.08
    percentages <- parts / total * 100
    paths <- sprintf('<circle cx="40" cy="40" r="25" fill="none" stroke="%s" stroke-width="15" stroke-dasharray="%f %f" stroke-dashoffset="-%f" transform="rotate(-90 40 40)"/>', colors, (percentages / 100) * circumference, circumference, c(0, cumsum(head((percentages / 100) * circumference, -1))))
    
    paste0('<svg width="80" height="80" viewBox="0 0 80 80">', paste(paths, collapse=""), sprintf('<text x="40" y="45" text-anchor="middle" font-size="12" font-weight="600">%d</text>', total), '</svg>')
  }

  # Bar chart builder
  build_css_bar <- function(low, high, recent_values_str, recent_dates_str, n) {
    # Generate sample for percentiles
    sample_size <- min(n, 200)
    all_values <- runif(sample_size, low, high)
    q15 <- quantile(all_values, 0.15, na.rm = TRUE)
    q85 <- quantile(all_values, 0.85, na.rm = TRUE)
    med <- median(all_values, na.rm = TRUE)
    
    # Parse recent data
    recent_values <- tryCatch({
      vals <- as.numeric(unlist(strsplit(as.character(recent_values_str), ",")))
      vals[!is.na(vals)]
    }, error = function(e) numeric(0))
    
    recent_dates <- tryCatch({
      dates <- unlist(strsplit(as.character(recent_dates_str), ","))
      dates[!is.na(dates) & dates != ""]
    }, error = function(e) character(0))
    
    # Ensure matching pairs and limit to 5
    min_length <- min(length(recent_values), length(recent_dates), 5)
    if (min_length > 0) {
      recent_values <- recent_values[1:min_length]
      recent_dates <- recent_dates[1:min_length]
    } else {
      recent_values <- med
      recent_dates <- "Recent"
    }
    
    # Build dots - SIMPLIFIED
    dots_html <- ""
    for (i in seq_along(recent_values)) {
      val <- recent_values[i]
      date <- recent_dates[i]
      y_pos <- 8 + (i-1) * 14
      
      # Simple categorization and positioning
      if (val < q15) {
        x_pos <- 7.5
        color <- "#6c757d"
      } else if (val > q85) {
        x_pos <- 92.5
        color <- "#6c757d"
      } else {
        if (q85 > q15) {
          relative_pos <- (val - q15) / (q85 - q15)
          x_pos <- 15 + relative_pos * 70
        } else {
          x_pos <- 50
        }
        color <- "#007BFF"  # Solid blue, no gradient
      }
      
      # Simple hover format - value (date)
      dots_html <- paste0(dots_html, sprintf(
        '<div style="position: absolute; top: %dpx; left: %.1f%%; width: 12px; height: 12px; background: %s; border: 2px solid white; border-radius: 50%%; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3);" title="%.1f (%s)"></div>',
        y_pos, x_pos, color, val, date
      ))
    }
    
    # Calculate median position
    median_pos <- if (q85 > q15) 15 + ((med - q15) / (q85 - q15)) * 70 else 50
    
    # Count summary
    num_low <- sum(recent_values < q15)
    num_high <- sum(recent_values > q85)
    num_normal <- length(recent_values) - num_low - num_high
    
    # Generate summary text
    summary_parts <- c()
    if (num_low > 0) summary_parts <- c(summary_parts, sprintf("%d in lower 15%%", num_low))
    if (num_normal > 0) summary_parts <- c(summary_parts, sprintf("%d in middle 70%%", num_normal))
    if (num_high > 0) summary_parts <- c(summary_parts, sprintf("%d in upper 15%%", num_high))
    
    summary_text <- if (length(summary_parts) > 0) {
      paste(summary_parts, collapse = ", ")
    } else {
      "All values in middle 70% of historical data"
    }
    
    sprintf(
      '<div style="position: relative; height: 80px; background: linear-gradient(to right, #f0f4f8 0%%, #f0f4f8 15%%, #ffffff 15%%, #ffffff 85%%, #f0f4f8 85%%, #f0f4f8 100%%); border-radius: 8px; border: 1px solid #dee2e6; overflow: visible; margin-top: 12px;">
         <div style="position: absolute; top: -18px; left: -20px; font-size: 10px; color: #6c757d; font-weight: 600; text-align: left; white-space: nowrap;">LOWER 15%% (< %.1f)</div>
         <div style="position: absolute; top: -18px; left: 15%%; font-size: 10px; color: #495057; font-weight: 600; text-align: center; width: 70%%; white-space: nowrap;">MIDDLE 70%% OF DATA (%.1f - %.1f)</div>
         <div style="position: absolute; top: -18px; right: -20px; font-size: 10px; color: #6c757d; font-weight: 600; text-align: right; white-space: nowrap;">UPPER 15%% (> %.1f)</div>
         <div style="position: absolute; top: 0; bottom: 0; left: 15%%; width: 2px; background: #6c757d; opacity: 0.3; border-radius: 1px;"></div>
         <div style="position: absolute; top: 0; bottom: 0; left: 85%%; width: 2px; background: #6c757d; opacity: 0.3; border-radius: 1px;"></div>
         <div style="position: absolute; top: 0; bottom: 0; left: 15%%; width: 70%%; background: rgba(0, 123, 255, 0.08); z-index: 1;" title="15th to 85th percentile range: %.1f - %.1f"></div>
         <div style="position: absolute; top: 0; bottom: 0; left: %.1f%%; width: 3px; background: #333; z-index: 2; border-radius: 2px;" title="Median (50th percentile): %.1f"></div>
         %s
       </div>',
      q15, q15, q85, q85, q15, q85, median_pos, med, dots_html
    )
  }

  css <- "
    .compact-table { border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; width: 100%; }
    .compact-table td { padding: 14px; vertical-align: top; border-bottom: 1px solid #f0f0f0; }
    .compact-table thead th { background-color: #f8f9fa; font-weight: 600; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center; }
    .param-info { text-align: left; width: 220px; word-wrap: break-word; }
    .param-name { font-weight: 600; font-size: 13px; color: #333; margin-bottom: 2px; word-wrap: break-word; line-height: 1.2; }
    .param-details { font-size: 12px; color: #666; line-height: 1.4; }
    .bar-column { width: 320px; text-align: center; }
    .threshold-column { width: 240px; text-align: center; }
    .donut-container-large { display: flex; flex-direction: row; align-items: center; gap: 12px; justify-content: center; }
    .legend-compact { font-size: 11px; text-align: left; max-width: 140px; }
  "

  color_map <- c("good" = "#28a745", "caution" = "#ffc107", "poor" = "#dc3545", "unknown" = "#999999")

  # Process rows with minimal overhead
  rows <- lapply(1:nrow(df), function(i) {
    row <- df[i, ]
    
    # Extract values efficiently
    low <- as.numeric(row$Lowest_Value)
    high <- as.numeric(row$Highest_Value) 
    val <- as.numeric(row$Most_Recent_Value)
    n <- as.numeric(row$Sample_Size)
    param <- as.character(row$CharacteristicName)
    unit <- as.character(row$Unit)
    
    # Single sprintf for parameter info
    param_info <- sprintf('<div class="param-info"><div class="param-name">%s (%s)</div><div class="param-details"><div>N = %d samples</div><div>Years: %s</div><div>Range: %.1f - %.1f %s</div><div>Most recent: %.1f (%s)</div></div></div>', param, unit, n, row$Year_Range, low, high, unit, val, row$Most_Recent_Sample_Date)

    # Bar chart
    bar_html <- tryCatch(build_css_bar(low, high, as.character(row$Recent_Values), as.character(row$Recent_Dates), n), error = function(e) sprintf('<div style="padding: 20px; text-align: center; color: #666;">Error: %s</div>', e$message))

    # Threshold lookup - simplified
    thresh_sub <- filtered_thresholds[filtered_thresholds$CharacteristicName_lower == tolower(param), ]

    if (nrow(thresh_sub) > 0) {
      donut_html <- build_css_donut(thresh_sub$n, color_map[thresh_sub$ThreshCateg], thresh_sub$ThreshCateg)
      legend_html <- paste(sprintf('<div style="color:%s; font-size: 11px;">%s: %d</div>', color_map[thresh_sub$ThreshCateg], tools::toTitleCase(thresh_sub$ThreshCateg), thresh_sub$n), collapse = "")
    } else {
      donut_html <- sprintf('<div style="width: 80px; height: 80px; border-radius: 50%%; background: #cccccc; display: flex; align-items: center; justify-content: center;"><span style="font-size: 12px;">%d</span></div>', n)
      legend_html <- '<div style="color:#666666; font-size: 11px;">Undefined</div>'
    }

    shiny::tags$tr(
      shiny::tags$td(htmltools::HTML(param_info)),
      shiny::tags$td(htmltools::HTML(bar_html), class = "bar-column"),
      shiny::tags$td(htmltools::HTML(sprintf('<div class="donut-container-large">%s<div class="legend-compact">%s</div></div>', donut_html, legend_html)), class = "threshold-column")
    )
  })

  shiny::tagList(
    shiny::tags$style(htmltools::HTML(css)),
    shiny::tags$table(
      class = "compact-table",
      style = "width: 100%; font-size: 12px;",
      shiny::tags$thead(
        shiny::tags$tr(
          shiny::tags$th("Parameter Details", style = "text-align: left; width: 220px;"),
          shiny::tags$th("Recent Values (up to 5 shown)", style = "width: 320px;"),
          shiny::tags$th("Threshold Assessment", style = "width: 240px;")
        )
      ),
      shiny::tags$tbody(rows)
    )
  )
}
```

Column {data-width = 1000}
-------------------------------------

```{r}
# Output the map
leafletOutput("param_map", height = "600px")
```

```{r}
output$param_map <- renderLeaflet({
  leaflet(data = sites_sf) |>
    addTiles() |>
    addCircleMarkers(
      layerId = ~MonitoringLocationIdentifier,
      label = ~MonitoringLocationIdentifier,
      radius = 8,
      color = "red",
      fillOpacity = 0.8,
      stroke = FALSE
    ) |>
    htmlwidgets::onRender("
      function(el, x) {
        this.on('contextmenu', function(e) {
          var clicked = null;
          this.eachLayer(function(layer) {
            if (layer.options && layer.options.layerId) {
              var latlng = layer.getLatLng();
              var dist = Math.sqrt(
                Math.pow(e.latlng.lat - latlng.lat, 2) +
                Math.pow(e.latlng.lng - latlng.lng, 2)
              );
              if (dist < 0.01) { clicked = layer.options.layerId; }
            }
          });
          if (clicked) {
            Shiny.setInputValue('map_right_click', {
              MonitoringLocationIdentifier: clicked,
              nonce: Math.random()
            });
          }
        });
      }
    ")
})

observeEvent(input$map_right_click, {
  site <- input$map_right_click$MonitoringLocationIdentifier
  df <- full_data %>% dplyr::filter(MonitoringLocationIdentifier == site)
  
  # TEMPORARY debug line
  debug_recent_data(df)
  
  shiny::showModal(
    shiny::modalDialog(
      title = paste("Summary for", site),
      generate_param_table(
        df = df,
        threshold_df = threshold_df,
        MonitoringLocationIdentifier = site
      ),
      easyClose = TRUE,
      size = "l"
    )
  )
})
  

```

